#!/bin/sh
# ************************************************
# * Corona-Info V1.92                            *
# *                                              *
# * zusammengestellt und angepasst von           *
# * fred_feuerstein (NI-Team)                    *
# *                                              *
# *                                              *
# * Daten kommen von                             *
# * https://corona.lmao.ninja/countries          *
# *                                              *
# * angezeigt werden ausgewählte Länder          *
# * Deutschland, Italien, Spanien, USA,          *
# * Oesterreich, Frankreich, Schweiz, China      *
# * Niederlande, UK, S.Korea, Russia             *
# *                                              *
# * gewünschte Länder können in der Datei        *
# * corona.land im Pluginverzeichnis editiert    *
# * werden. (Länderkennzeich,Anzeigename)        *
# ************************************************


# Bitte Variablen ggfs. anpassen:
#################################################

# Aufrufvariante für Download, "WGET" oder "CURL" bitte auswählen
command="WGET" 

# pluginpath entsprechend setzen, ggfs. von /var/tuxbox/plugins auf /share/tuxbox/neutrino/plugins" ändern
# pluginpath mit $(dirname $0) sollte bei allen passen ;) (thx. DboxOldie)
pluginpath="$(dirname "$0")"

# Verzeichnis, in dem die persönliche corona.land Datei liegt
landpath="/var/tuxbox/config"

# Tuxwetter
tux_wetter="/bin/tuxwetter"


# ab hier keine Eintragung mehr nötig
#################################################

title="Corona-Info"
vinfo="V1.92"
icon=$pluginpath"/corona_hint.png"

cleanup() {
	rm -rf /tmp/corona*
	echo "Corona-Info - Temp-Dateien gelöscht"
}

# automatisches cleanup bei Script-Ende
trap cleanup EXIT

echo "--------------------------------------------------"
echo "Corona-Info "$vinfo" startet"
echo "-----------------------------by fred_feuerstein---"

fallurl="https://www.neutrino-images.de/storage/public/corona-info/faelle.png"
toteurl="https://www.neutrino-images.de/storage/public/corona-info/tote.png"
deuurl="https://upload.wikimedia.org/wikipedia/commons/thumb/a/af/COVID-19_outbreak_Germany_per_capita_cases_map.svg/800px-COVID-19_outbreak_Germany_per_capita_cases_map.svg.png"

repeat=""
fallstring="PICTURE=fall,|PNG$repeat|$fallurl"
totestring="PICTURE=tote,|PNG$repeat|$toteurl"
destring="PICTURE=deu,|PNG$repeat|$deurl"

fallgrafik() {
  if [ -e $tux_wetter ]; then
      $tux_wetter "$fallstring" >/dev/null &
      sleep 10
      killall tuxwetter >/dev/null
    else
      msgbox popup="Tuxwetter nicht installiert - keine Bildanzeige!" icon="$path" title="$titletext1 $vinfo ($command)" timeout=03
      echo "Corona-Info - tuxwetter nicht installiert - keine Bildanzeige"
  fi
}

totegrafik() {
  if [ -e $tux_wetter ]; then
      $tux_wetter "$totestring" >/dev/null &
      sleep 10
      killall tuxwetter >/dev/null
    else
      msgbox popup="Tuxwetter nicht installiert - keine Bildanzeige!" icon="$path" title="$titletext1 $vinfo ($command)" timeout=03
      echo "Corona-Info - tuxwetter nicht installiert - keine Bildanzeige"
  fi
}

deugrafik() {
  if [ -e $tux_wetter ]; then
      $tux_wetter "$destring" >/dev/null &
      sleep 10
      killall tuxwetter >/dev/null
    else
      msgbox popup="Tuxwetter nicht installiert - keine Bildanzeige!" icon="$path" title="$titletext1 $vinfo ($command)" timeout=03
      echo "Corona-Info - tuxwetter nicht installiert - keine Bildanzeige"
  fi
}

cleanup

landfile="$landpath"/corona.land
msgboxfile=/tmp/corona.msgbox
countriesfile=/tmp/corona.countries
worldfile=/tmp/corona.world

if [ -e "$landfile" ]; then
	echo "Corona-Info - corona.land ("$landpath") Datei wird genutzt"
else 
	landfile=/tmp/corona.land
	echo '"DEU",Deutschland' >> $landfile
	echo '"ITA",Italien' >> $landfile
	echo '"ESP",Spanien' >> $landfile
	echo '"PRT",Portugal' >> $landfile
	echo '"USA",USA' >> $landfile
	echo '"AUT",~Osterreich' >> $landfile
	echo '"CH",Schweiz' >> $landfile
	echo '"FRA",Frankreich' >> $landfile
	echo '"NL",Niederlande' >> $landfile
	echo '"CHN",China' >> $landfile
	echo '"KOR",S~udkorea' >> $landfile
	echo '"RUS",Russland' >> $landfile
	echo '"UK",Gro~zbritannien' >> $landfile
	echo "Corona-Info - corona.land nicht vorhanden - Default-Laender werden genutzt"
fi

lines=$(sed $= -n $landfile)

echo "Corona-Info - Länderanzahl = "$lines". "

msgbox popup="Daten werden geholt... (ca. 6 Sekunden)" icon="$icon" title="$title $vinfo ($command)" timeout=02

echo "Corona-Info - Länderdaten-Download"

if [ $command = "WGET" ]; then
	wget -O $countriesfile https://corona.lmao.ninja/countries --no-check-certificate
	wget -O $worldfile https://corona.lmao.ninja/all --no-check-certificate
else
	curl -k -o $countriesfile https://corona.lmao.ninja/countries
	curl -k -o $worldfile https://corona.lmao.ninja/all
fi 

if [ -e $countriesfile ]; then
	sed -i -e 's|{"country|\n{"country|g' $countriesfile
	echo "Corona-Info - Länderdaten erfolgreich geladen"
else
	echo "Corona-Info - Länderdaten in $countriesfile nicht gefunden"
fi

if [ -e $worldfile ]; then
	echo "Corona-Info - Länderdaten-Summe erfolgreich geladen"
else
	echo "Corona-Info - Länderdaten-Summe in $worldfile nicht gefunden"
fi

# Übersicht erstellen

echo "Corona-Info - Daten werden aufbereitet zur Anzeige"

echo "~s" > $msgboxfile
echo "Land    ~T0240~YGesamt  ~T0340      ~T0420~RGesamt ~T0500 ~T0580 ~T0650~YErkrankt ~T0745~B ~T0830~GGeheilt ~T0930~YFälle p.  ~T1035~RTote p." >> $msgboxfile
echo " ~T0240~YInfizierte  ~T0340heute      ~T0420~RTote ~T0500Quote ~T0580heute ~T0650~Ymild ~T0745~Bkritisch ~T0830~Ggemeldet ~T0930~YMio.Einw  ~T1035~RMio.Einw" >> $msgboxfile
echo "~s" >> $msgboxfile

# Werte aller Länder ermitteln und in Datei speichern

i=0
for i in $(seq 1 "$lines"); do
	landtemp=0
	LAND=0
	GESAMT=0
	NEU_HEUTE=0
	TOTE=0
	TOTE_HEUTE=0
	GEHEILT=0
	ERKRANKT=0
	KRITISCH=0
	FALLPROMILLION=0
	TOTEPROMILLION=0

	landtemp=$(head -n"$i" $landfile | tail -n1 | cut -d "," -f1)
	landanzeige=$(head -n"$i" $landfile | tail -n1 | cut -d "," -f2)

	LAND=$(cat $countriesfile | grep "$landtemp")
	GESAMT=$(echo "$LAND" | sed 's/.*cases":\(.*\)$/\1/' | cut -d "," -f1)
	NEU_HEUTE=$(echo "$LAND" | sed 's/.*todayCases":\(.*\)$/\1/' | cut -d "," -f1)
	TOTE=$(echo "$LAND" | sed 's/.*deaths":\(.*\)$/\1/' | cut -d "," -f1)
	TOTE_HEUTE=$(echo "$LAND" | sed 's/.*todayDeaths":\(.*\)$/\1/' | cut -d "," -f1)
	QUOTETEMP=$(echo | awk '{print '$TOTE'*100/'$GESAMT'}')
	QUOTE=$(printf "%.1f\n" $QUOTETEMP)
	GEHEILT=$(echo "$LAND" | sed 's/.*recovered":\(.*\)$/\1/' | cut -d "," -f1)
	ERKRANKT=$(echo "$LAND" | sed 's/.*active":\(.*\)$/\1/' | cut -d "," -f1)
	KRITISCH=$(echo "$LAND" | sed 's/.*critical":\(.*\)$/\1/' | cut -d "," -f1)
	FALLPROMILLION=$(echo "$LAND" | sed 's/.*casesPerOneMillion":\(.*\)$/\1/' | cut -d "," -f1)
	TOTEPROMILLION=$(echo "$LAND" | sed 's/.*deathsPerOneMillion":\(.*\)$/\1/' | cut -d "," -f1)

	echo $landanzeige" ~T0240~Y"$GESAMT" ~T0340"$NEU_HEUTE"  ~T0420~R"$TOTE"  ~T0500"$QUOTE"% ~T0580"$TOTE_HEUTE" ~T0650~Y"$ERKRANKT" ~T0745~B"$KRITISCH" ~T0830~G"$GEHEILT" ~T0930~Y"$FALLPROMILLION" ~T1035~R"$TOTEPROMILLION"" >> $msgboxfile
done

# Gesamtwerte ermitteln und in Datei speichern

ALL=$(cat $worldfile)
ALL_GESAMT=$(echo "$ALL" | sed 's/.*cases":\(.*\)$/\1/' | cut -d "," -f1)
ALL_TOTE=$(echo "$ALL" | sed 's/.*deaths":\(.*\)$/\1/' | cut -d "," -f1)
ALL_GEHEILT=$(echo "$ALL" | sed 's/.*recovered":\(.*\)$/\1/' | cut -d "," -f1)
ALL_ERKRANKT=$(echo "$ALL" | sed 's/.*active":\(.*\)$/\1/' | cut -d "," -f1)
ALL_QUOTETEMP=$(echo | awk '{print '$ALL_TOTE'*100/'$ALL_GESAMT'}')
ALL_QUOTE=$(printf "%.1f\n" $ALL_QUOTETEMP)
ALL_ANZAHL=$(echo "$ALL" | sed 's/.*affectedCountries":\(.*\)$/\1/' | cut -d "}" -f1)
ALL_UPDATETEMP=$(echo "$ALL" | sed 's/.*updated":\(.*\)$/\1/' | cut -d "," -f1)
ALL_UPDATE=$(date -d @${ALL_UPDATETEMP:0:10} '+%d.%m.%Y - %H:%M')

echo "~s" >> $msgboxfile
echo "Gesamt Weltweit ~T0240~Y"$ALL_GESAMT" ~T0340  ~T0420~R"$ALL_TOTE"  ~T0500"$ALL_QUOTE"% ~T0580 ~T0650~Y"$ALL_ERKRANKT" ~T0745~B ~T0830~G"$ALL_GEHEILT" ~T0930~SAnz. Länder: "$ALL_ANZAHL"" >> $msgboxfile
echo "~s" >> $msgboxfile
echo "~cQuelle: https://corona.lmao.ninja/countries - Datenstand: "$ALL_UPDATE" Uhr" >> $msgboxfile 
echo "~cDie Liste der L~ander kann in der Datei corona.land editiert/sortiert werden. fred_feuerstein (NI-Team)" >> $msgboxfile 

echo "Corona-Info - Übersicht wurde erstellt"

# Schriftgröße ermitteln

if [ "$lines" -ge "24" ]; then
	rowsize="15"
elif [ "$lines" -ge "19" ]; then
	rowsize="17"
elif [ "$lines" -ge "17" ]; then
	rowsize="19" 
elif [ "$lines" -le "16" ]; then
	rowsize="21"
fi

echo "Corona-Info - Schriftgröße "$rowsize" eingestellt!"

# Übersicht anzeigen

echo "Corona-Info - Bitte warten, Anzeige am TV wird vorbereitet  und angezeigt"

while :; do
	auswahl=2
	msgbox msg="$msgboxfile" size="$rowsize" icon="$icon" title="$title $vinfo" select="F~ALLE_WHO,EXIT,TOTE_WHO" order=3 default=$auswahl >/dev/null
	auswahl=$?
	case $auswahl in
	  1)
      fallgrafik
      echo "Corona-Info - Grafik-Fälle-Weltweit-WHO"
  		;;		
	  2)
		  #Abbruch
      echo "Corona-Info - Exit (OK-Taste)"
			break
   		;;
	  3)
      totegrafik
      echo "Corona-Info - Grafik-Tote-Weltweit-WHO"
  		;;		
	  4)
	    deugrafik
	    echo "Corona-Info - Deutschland-Grafik-WHO"
	    ;;
		*)
			echo "Corona-Info - Exit (Exit-Taste/Timeout)"
			break
		  ;;
	esac
done

exit 0
